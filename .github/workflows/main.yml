name: Build, Push and Run Docker Image

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # ðŸ”¹ BUILD (sem Firebase)
      - name: Build Docker Image
        run: |
          docker build \
            -t ${{ secrets.DOCKER_USERNAME }}/postai:latest \
            --build-arg SUPABASE_URL=${{ secrets.SUPABASE_URL }} \
            --build-arg SUPABASE_KEY=${{ secrets.SUPABASE_KEY }} \
            .
      - name: Push Docker Image
        run: docker push ${{ secrets.DOCKER_USERNAME }}/postai:latest

      - name: Run Container with Firebase Secrets
        run: |
          docker run \
            -e FIREBASE_TYPE="${{ secrets.FIREBASE_TYPE }}" \
            -e FIREBASE_PROJECT_ID="${{ secrets.FIREBASE_PROJECT_ID }}" \
            -e FIREBASE_PRIVATE_KEY="${{ secrets.FIREBASE_PRIVATE_KEY }}" \
            -e FIREBASE_CLIENT_EMAIL="${{ secrets.FIREBASE_CLIENT_EMAIL }}" \
            -e FIREBASE_AUTH_URI="${{ secrets.FIREBASE_AUTH_URI }}" \
            -e FIREBASE_TOKEN_URI="${{ secrets.FIREBASE_TOKEN_URI }}" \
            -e FIREBASE_AUTH_PROVIDER_X509_CERT_URL="${{ secrets.FIREBASE_AUTH_PROVIDER_X509_CERT_URL }}" \
            -e FIREBASE_CLIENT_X509_CERT_URL="${{ secrets.FIREBASE_CLIENT_X509_CERT_URL }}" \
            -e FIREBASE_UNIVERSE_DOMAIN="${{ secrets.FIREBASE_UNIVERSE_DOMAIN }}" \
            -e FIREBASE_STORAGE_BUCKET="${{ secrets.FIREBASE_STORAGE_BUCKET }}" \
            ${{ secrets.DOCKER_USERNAME }}/postai:latest